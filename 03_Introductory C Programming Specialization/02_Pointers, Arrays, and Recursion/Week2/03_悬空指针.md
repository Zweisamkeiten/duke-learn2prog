---
date created: 2022-10-13 20:57
date updated: 2022-10-15 22:17
---

能很想从函数中返回一个数组

每当您有一个指向其内存已被释放的东西的指针时，它就被称为 _悬空指针_ 。

解引用悬空指针会导致未定义的行为（因此代表您的代码存在严重问题），因为您不知道箭头末尾的值是什么。

```c
warning: function returns address of local variable [-Wreturn-local-addr]
   return myArray;
```

请记住存储在内存中的值将一直保留在那里，直到被程序更改——并且释放的内存位置可能不会立即被重用。 一旦函数返回并且其帧被销毁，作为该帧一部分的内存位置将不会被重用，直到必须将更多值放置在栈上。 如果我们调用另一个函数，它的帧将被放置在下一个可用的栈槽中，覆盖最近释放的内存。 只有在这一点上，与解除分配的栈帧相关的值才会改变（由于分配给新帧中的变量）。 现在通过悬空指针写入内存将以不可预知的方式更改该帧中的变量。 请注意， _即使您没有调用另一个函数，使用悬空指针指向已释放帧也是不安全_ 的——即使大多数栈分配来自调用函数，也不能保证这些是栈的唯一方式用过的。

![](attachments/Pasted%20image%2020221013211637.png)

函数 initArray 试图返回 myArray 整个数组.  事实上, myArray 是指向 initArray 函数开辟的 frame 帧栈中的两个 box, 当函数返回时,其帧栈也被销毁了, 导致其返回的指针赋给 p, 使之成为了一个悬空指针.

#important
为什么函数可以返回结构体而不能返回数组

当一个函数返回一个 `struct`（或任何其他类型的变量） _按 value_ ，然后制作该变量或结构的 **副本** ，并将该副本返回给调用者。 因此，即使函数结束时“原件”已不复存在，副本仍然有效。

但是，当函数返回一个数组时， _实际_ 返回的是该数组的第一个元素的地址 - 请参阅 [什么是数组到指针衰减？](https://stackoverflow.com/q/1461432/10871073) 因此，在这种情况下，当函数完成时，本地数组不再“存在”并且返回的地址变得无效。

因此可以将数组填入结构体中进行返回.
